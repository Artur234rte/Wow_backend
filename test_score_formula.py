"""
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ score
–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º score –∏–∑ WCL —Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –ø–æ —Ñ–æ—Ä–º—É–ª–µ Blizzard
"""
import asyncio
import httpx
import json
import math

CLIENT_ID = "a0c39d1e-d0c5-4845-bffc-8c8613c6c474"
CLIENT_SECRET = "zT6WdIWjVwrCmOlDCNLWwgYt0DULsVSTHWOPRbiU"
TOKEN_URL = "https://www.warcraftlogs.com/oauth/token"
API_URL = "https://www.warcraftlogs.com/api/v2/client"


def calculate_mythic_plus_score(key_level: int, time_limit_ms: int, actual_time_ms: int, upgraded: bool = False) -> float:
    """
    –†–∞—Å—á–µ—Ç Mythic+ score –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª–µ Blizzard

    –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞:
    - –ë–∞–∑–æ–≤—ã–π score –¥–ª—è —É—Ä–æ–≤–Ω—è –∫–ª—é—á–∞ (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç)
    - –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ (–±–æ–Ω—É—Å –∑–∞ –±—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ, —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ)
    - –ë–æ–Ω—É—Å –∑–∞ upgrade (chest at the end)

    –ò—Å—Ç–æ—á–Ω–∏–∫: https://www.wowhead.com/guide/blizzard-mythic-plus-rating-score-in-game
    """

    # –ë–∞–∑–æ–≤—ã–π score –¥–ª—è —É—Ä–æ–≤–Ω—è –∫–ª—é—á–∞ (–ø—Ä–∏–º–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞, —Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)
    # –î–ª—è —É—Ä–æ–≤–Ω—è 10 –±–∞–∑–æ–≤—ã–π score ~125, –¥–ª—è 15 ~190, –¥–ª—è 20 ~240
    # –§–æ—Ä–º—É–ª–∞: base = 75 + (level * 8) + (level^1.5 * 2)

    base_score = 75 + (key_level * 8) + (key_level ** 1.5 * 2)

    # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
    time_ratio = actual_time_ms / time_limit_ms

    if time_ratio <= 0.6:  # +3 chest (40% –±—ã—Å—Ç—Ä–µ–µ)
        time_modifier = 1.5
    elif time_ratio <= 0.8:  # +2 chest (20% –±—ã—Å—Ç—Ä–µ–µ)
        time_modifier = 1.3
    elif time_ratio <= 1.0:  # +1 chest (–≤ —Å—Ä–æ–∫)
        time_modifier = 1.0
    else:  # Overtime
        # –®—Ç—Ä–∞—Ñ –∑–∞ –∫–∞–∂–¥—ã–π % –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        overtime_percent = (time_ratio - 1.0) * 100
        time_modifier = max(0.6, 1.0 - (overtime_percent * 0.02))  # -2% –∑–∞ –∫–∞–∂–¥—ã–π % –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è

    final_score = base_score * time_modifier

    return final_score


async def test_score_calculation():
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
    async with httpx.AsyncClient() as client:
        resp = await client.post(
            TOKEN_URL,
            data={"grant_type": "client_credentials"},
            auth=(CLIENT_ID, CLIENT_SECRET)
        )
        token = resp.json()["access_token"]

        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-5 –∑–∞–±–µ–≥–æ–≤ —Å playerscore
        query = """
        query {
          worldData {
            encounter(id: 62660) {
              name
              characterRankings(
                metric: playerscore
                leaderboard: LogsOnly
                size: 10
              )
            }
          }
        }
        """

        resp2 = await client.post(
            API_URL,
            json={"query": query},
            headers={"Authorization": f"Bearer {token}"}
        )

        data = resp2.json()

        print("="*80)
        print("–ê–ù–ê–õ–ò–ó SCORE –ò–ó WARCRAFTLOGS")
        print("="*80)

        if "data" in data:
            rankings = data["data"]["worldData"]["encounter"]["characterRankings"]
            if "rankings" in rankings and rankings["rankings"]:
                print(f"\nüìä –ê–Ω–∞–ª–∏–∑ —Ç–æ–ø-{len(rankings['rankings'])} –∑–∞–±–µ–≥–æ–≤:\n")

                for idx, run in enumerate(rankings["rankings"][:10], 1):
                    key_level = run.get("hardModeLevel", 0)
                    duration_ms = run.get("duration", 0)
                    score = run.get("score", 0)
                    medal = run.get("medal", "")
                    name = run.get("name", "Unknown")

                    # –ü—Ä–∏–º–µ—Ä–Ω—ã–π time limit –¥–ª—è +22 –∫–ª—é—á–∞ Ara-Kara (–æ–±—ã—á–Ω–æ ~30 –º–∏–Ω—É—Ç)
                    # –¢–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–¥–∑–µ–º–µ–ª—å—è
                    estimated_time_limit_ms = 30 * 60 * 1000  # 30 –º–∏–Ω—É—Ç

                    duration_sec = duration_ms / 1000
                    duration_min = duration_sec / 60

                    # –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç
                    # calculated_score = calculate_mythic_plus_score(
                    #     key_level,
                    #     estimated_time_limit_ms,
                    #     duration_ms
                    # )

                    print(f"{idx}. {name}")
                    print(f"   Level: +{key_level}")
                    print(f"   Time: {duration_min:.1f} min ({duration_sec:.0f}s)")
                    print(f"   Medal: {medal}")
                    print(f"   Score (WCL): {score:.2f}")
                    # print(f"   Score (—Ä–∞—Å—á–µ—Ç): {calculated_score:.2f}")
                    # print(f"   –†–∞–∑–Ω–∏—Ü–∞: {abs(score - calculated_score):.2f}")
                    print()

        print("="*80)
        print("–í–´–í–û–î–´")
        print("="*80)
        print("""
üîç –ß–¢–û –ú–´ –í–ò–î–ò–ú:

1. Score –∏–∑ WCL –¥–ª—è metric: playerscore
   - –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ score –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π M+ –∑–∞–±–µ–≥
   - –ó–Ω–∞—á–µ–Ω–∏—è ~500-520 –¥–ª—è –∫–ª—é—á–µ–π +22 —É—Ä–æ–≤–Ω—è
   - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∫–ª—é—á–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è

2. –ú–µ–¥–∞–ª–∏ (bronze, silver, gold)
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –±—ã–ª –ø—Ä–æ–π–¥–µ–Ω –∫–ª—é—á
   - Gold = –≤ —Å—Ä–æ–∫ –∏–ª–∏ –±—ã—Å—Ç—Ä–µ–µ
   - Silver/Bronze = —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏

‚ùì –ú–û–ñ–ù–û –õ–ò –†–ê–°–°–ß–ò–¢–ê–¢–¨ RIO –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û?

–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò - –î–ê, –ù–û –° –û–ì–†–û–ú–ù–´–ú–ò –ü–†–û–ë–õ–ï–ú–ê–ú–ò:

‚úÖ –ß–¢–û –ù–£–ñ–ù–û –î–õ–Ø –†–ê–°–ß–ï–¢–ê RIO:

1. –ü–æ–ª—É—á–∏—Ç—å –õ–£–ß–®–ò–ô –∑–∞–±–µ–≥ –∏–≥—Ä–æ–∫–∞ –ø–æ –ö–ê–ñ–î–û–ú–£ –ø–æ–¥–∑–µ–º–µ–ª—å—é —Å–µ–∑–æ–Ω–∞
   - –î–ª—è Tyrannical affixes
   - –î–ª—è Fortified affixes
   (–≤—Å–µ–≥–æ 2 –∑–∞–±–µ–≥–∞ –Ω–∞ –ø–æ–¥–∑–µ–º–µ–ª—å–µ = 16 –∑–∞–±–µ–≥–æ–≤ –Ω–∞ 8 –ø–æ–¥–∑–µ–º–µ–ª–∏–π)

2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–±–µ–≥–∞ –∑–Ω–∞—Ç—å:
   - –£—Ä–æ–≤–µ–Ω—å –∫–ª—é—á–∞
   - –í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
   - Time limit –ø–æ–¥–∑–µ–º–µ–ª—å—è
   - –†–∞—Å—Å—á–∏—Ç–∞—Ç—å score –ø–æ —Ñ–æ—Ä–º—É–ª–µ Blizzard

3. –°–ª–æ–∂–∏—Ç—å –≤—Å–µ scores

‚ùå –ü–û–ß–ï–ú–£ –≠–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –° WCL:

1. **WCL –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ LEADERBOARD (—Ç–æ–ø –∑–∞–±–µ–≥–∏)**
   - –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ –≤ —Ç–æ–ø–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–¥–∑–µ–º–µ–ª—å—è - –º—ã –ù–ï –≤–∏–¥–∏–º –µ–≥–æ –∑–∞–±–µ–≥
   - –ù–∞–º –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫–æ –í–°–ï–ú –∑–∞–±–µ–≥–∞–º –∏–≥—Ä–æ–∫–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–æ–ø–æ–≤—ã–º

2. **–ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–∏—Ç—å –í–°–ï –∑–∞–±–µ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞**
   - characterRankings –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø –ø–æ –ø–æ–¥–∑–µ–º–µ–ª—å—é/–∫–ª–∞—Å—Å—É/—Å–ø–µ–∫—É
   - –ù–µ—Ç endpoint'–∞ "–¥–∞–π –º–Ω–µ –≤—Å–µ M+ –∑–∞–±–µ–≥–∏ –∏–≥—Ä–æ–∫–∞ X"

3. **–ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª—ã**
   - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ Blizzard –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
   - Raider.IO –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ Blizzard API —Å —Ç–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

4. **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å affixes**
   - –ù—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ —Ç—Ä–µ–∫–∞—Ç—å Tyrannical –∏ Fortified –Ω–µ–¥–µ–ª–∏
   - WCL API –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º affixes

üéØ –ò–¢–û–ì–û–í–´–ô –û–¢–í–ï–¢ –ù–ê –í–ê–® –í–û–ü–†–û–°:

‚ùå –ù–ï–¢, –º—ã –ù–ï –ú–û–ñ–ï–ú —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å RIO —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–∑ WCL, –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. WCL –ù–ï –ü–†–ï–î–û–°–¢–ê–í–õ–Ø–ï–¢ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–æ –≤—Å–µ—Ö –∑–∞–±–µ–≥–∞—Ö –∏–≥—Ä–æ–∫–∞
2. WCL –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¢–û–ü–û–í–´–ï –∑–∞–±–µ–≥–∏ –≤ leaderboard
3. –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ù–ï –≤ —Ç–æ–ø–µ - –º—ã –ù–ï —É–≤–∏–¥–∏–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï:

–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Raider.IO API:
- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ Blizzard API
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤
- –î–æ—Å—Ç—É–ø –∫–æ –í–°–ï–ú –∑–∞–±–µ–≥–∞–º –∏–≥—Ä–æ–∫–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–æ–ø–æ–≤—ã–º)

üí° –ß–¢–û –ú–´ –£–ñ–ï –î–ï–õ–ê–ï–ú –ü–†–ê–í–ò–õ–¨–ù–û:

–í view.py:263-352 –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Raider.IO API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è RIO scores.
–≠—Ç–æ –ï–î–ò–ù–°–¢–í–ï–ù–ù–û –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–Ω—ã—Ö RIO –¥–∞–Ω–Ω—ã—Ö.

WarcraftLogs –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
- –ü–æ–ª—É—á–µ–Ω–∏—è gear –∏ talents (includeCombatantInfo)
- –ê–Ω–∞–ª–∏–∑–∞ DPS/HPS
- –î–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±–æ–µ–≤

–ù–æ –ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
- –ü–æ–ª—É—á–µ–Ω–∏—è RIO scores –∏–≥—Ä–æ–∫–æ–≤
- –ü–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ M+ –∑–∞–±–µ–≥–æ–≤ –∏–≥—Ä–æ–∫–∞
        """)


asyncio.run(test_score_calculation())

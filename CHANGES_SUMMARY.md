# –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π: LOW/HIGH Keys Support

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö ([app/models/model.py](app/models/model.py:10-26))

–î–æ–±–∞–≤–ª–µ–Ω—ã 3 –Ω–æ–≤—ã—Ö –ø–æ–ª—è:
- `key: str | None` - —Ç–∏–ø –∫–ª—é—á–∞ ("low" –∏–ª–∏ "high")
- `average_dps: float | None` - —Å—Ä–µ–¥–Ω–∏–π DPS
- `max_key_level: int | None` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∫–ª—é—á–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è high keys)

UniqueConstraint –æ–±–Ω–æ–≤–ª–µ–Ω: —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–µ `key`

---

### 2. GraphQL –∑–∞–ø—Ä–æ—Å—ã ([app/agregator/quieres.py](app/agregator/quieres.py:21-60))

–î–æ–±–∞–≤–ª–µ–Ω—ã 2 –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞:
- `QUERY_FOR_MYTHIC_PLUS_LOW_KEYS` - –¥–ª—è low keys —Å `bracket: 11`, `metric: dps`
- `QUERY_FOR_MYTHIC_PLUS_HIGH_KEYS` - –¥–ª—è high keys —Å `metric: dps`

---

### 3. –§—É–Ω–∫—Ü–∏—è fetch_leaderboard_optimized ([app/agregator/view.py](app/agregator/view.py:333-483))

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `query: str = None` - GraphQL –∑–∞–ø—Ä–æ—Å
- `key_type: str = None` - "low" –∏–ª–∏ "high"

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ `key_type` —É–∫–∞–∑–∞–Ω, —Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π DPS –∏ max_key_level
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Dict –≤–º–µ—Å—Ç–æ float:
  ```python
  {
      "average_rio": 2850.5,     # –µ—Å–ª–∏ query = q_simple
      "average_dps": 2850000.0,  # –µ—Å–ª–∏ key_type —É–∫–∞–∑–∞–Ω
      "max_key_level": 22        # –µ—Å–ª–∏ key_type = "high"
  }
  ```

---

### 4. –§—É–Ω–∫—Ü–∏—è fetch_single_spec_meta ([app/agregator/view.py](app/agregator/view.py:486-566))

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `key_type: str = None` - "low" –∏–ª–∏ "high"
- `query: str = None` - GraphQL –∑–∞–ø—Ä–æ—Å

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç query –ø–æ key_type
- –°–æ–∑–¥–∞–µ—Ç MetaBySpec —Å –ø–æ–ª—è–º–∏ `key`, `average_dps`, `max_key_level`
- meta –±–µ—Ä–µ—Ç—Å—è –∏–∑ average_rio (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –∏–∑ average_dps

---

### 5. –§—É–Ω–∫—Ü–∏—è test_leaderboard ([app/agregator/view.py](app/agregator/view.py:569-605))

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ—Ç **2 –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–∞–∂–¥—É—é —Å–ø–µ–∫—É**:
  - LOW KEYS: `key_type="low"`, `query=QUERY_FOR_MYTHIC_PLUS_LOW_KEYS`
  - HIGH KEYS: `key_type="high"`, `query=QUERY_FOR_MYTHIC_PLUS_HIGH_KEYS`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–¥–≤–æ–µ –±–æ–ª—å—à–µ –∑–∞–¥–∞—á (–±—ã–ª–æ N, —Å—Ç–∞–ª–æ 2N)
- –ö–∞–∂–¥–∞—è —Å–ø–µ–∫–∞ –∏–º–µ–µ—Ç 2 –∑–∞–ø–∏—Å–∏ –≤ –ë–î: low –∏ high

---

### 6. –§—É–Ω–∫—Ü–∏—è batch_add_meta_by_spec ([app/agregator/view.py](app/agregator/view.py:69-93))

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- WHERE —É—Å–ª–æ–≤–∏–µ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–µ `key`
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è `average_dps` –∏ `max_key_level`

---

## –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **test_low_high_keys.py** - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
2. **LOW_HIGH_KEYS_GUIDE.md** - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
3. **CHANGES_SUMMARY.md** - –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **API_FILTERS_GUIDE.md** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º WarcraftLogs API

---

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
python3 -m app.agregator.view

# –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
python3 test_low_high_keys.py
```

---

### –ó–∞–ø—Ä–æ—Å –∫ –ë–î

```python
from sqlalchemy import select
from app.models.model import MetaBySpec

# –ü–æ–ª—É—á–∏—Ç—å LOW KEYS
stmt = select(MetaBySpec).where(
    MetaBySpec.encounter_id == 62660,
    MetaBySpec.key == "low"
)

# –ü–æ–ª—É—á–∏—Ç—å HIGH KEYS
stmt = select(MetaBySpec).where(
    MetaBySpec.encounter_id == 62660,
    MetaBySpec.key == "high"
)
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
id | class_name | spec   | meta | spec_type | encounter_id
---+------------+--------+------+-----------+-------------
1  | Priest     | Shadow | 2850 | dps       | 62660
```

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
id | class_name | spec   | meta    | spec_type | encounter_id | key  | average_dps | max_key_level
---+------------+--------+---------+-----------+--------------+------+-------------+--------------
1  | Priest     | Shadow | 2150000 | dps       | 62660        | low  | 2150000.0   | NULL
2  | Priest     | Shadow | 3200000 | dps       | 62660        | high | 3200000.0   | 22
```

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)

```bash
# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ë–î –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
rm instance/wow.db  # –∏–ª–∏ –≤–∞—à–∞ –ë–î
python3 -m app.agregator.view  # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å API endpoints (–µ—Å–ª–∏ –µ—Å—Ç—å)

–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `key_type` –≤ API:

```python
@app.get("/api/meta/{encounter_id}")
async def get_meta(encounter_id: int, key_type: str = "high"):
    # ...
```

### 3. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å LOW/HIGH keys:

```javascript
// –ü—Ä–∏–º–µ—Ä
const [keyType, setKeyType] = useState('high');

fetch(`/api/meta/${encounterId}?key_type=${keyType}`)
  .then(res => res.json())
  .then(data => {
    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
  });
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
python3 test_low_high_keys.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Access token –ø–æ–ª—É—á–µ–Ω
–ü–æ–ª—É—á–µ–Ω–æ 100 –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è DeathKnight Blood (low keys)
‚úÖ DeathKnight Blood (low keys): avg_dps=2150000
–ü–æ–ª—É—á–µ–Ω–æ 100 –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è DeathKnight Blood (high keys)
‚úÖ DeathKnight Blood (high keys): avg_dps=3200000, max_key=22

–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ë–û–†–ê:
  LOW KEYS:  6 –∑–∞–ø–∏—Å–µ–π
  HIGH KEYS: 6 –∑–∞–ø–∏—Å–µ–π
  –í–°–ï–ì–û:     12 –∑–∞–ø–∏—Å–µ–π
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. UniqueConstraint violation

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ë–î –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

---

### 2. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è low keys

**–ü—Ä–æ–±–ª–µ–º–∞:** `bracket: 11` –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è M+11+ –≤ WarcraftLogs:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GraphQL Playground
# https://www.warcraftlogs.com/api/graphiql
```

---

### 3. Rate limiting

**–ü—Ä–æ–±–ª–µ–º–∞:** 429 Too Many Requests

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ —á–µ—Ä–µ–∑ `_api_semaphore` (5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

---

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã**:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ –ø–æ–ª—è nullable, –ø–æ—ç—Ç–æ–º—É —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–µ —Å–ª–æ–º–∞—é—Ç—Å—è
- –ú–æ–∂–Ω–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ LOW/HIGH keys
‚úÖ –°—Ä–µ–¥–Ω–∏–π DPS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∫–ª—é—á–µ–π
‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∫–ª—é—á–∞ –¥–ª—è high keys
‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ
